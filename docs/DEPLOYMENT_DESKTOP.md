# Desktop Deployment Guide (Windows)

## Build Installer
1. `npm install`
2. `npm run build`
3. `npm run desktop:win`

## Output Artifacts
- Installer: `release/SingBetter AI Setup 1.0.0.exe`
- Unpacked build: `release/win-unpacked/`

## Runtime Behavior
- Embedded server starts on `127.0.0.1:5510`.
- Desktop app stores data in Electron `userData` (Windows default `%APPDATA%/SingBetter AI/`):
  - `singbetter.db`
  - `uploads/`
  - `session.secret`
- Desktop startup logs print one line with the resolved paths:
  - `userData=<...> db=<...> uploads=<...>`
- On first run, if `singbetter.db` does not exist, the app attempts one-time migration copy from:
  - project `dev.db`
  - project `prod-local.db`
  - legacy desktop `%APPDATA%/SingBetter AI/desktop.db`

## Security Defaults
- `contextIsolation: true`
- `nodeIntegration: false`
- `sandbox: true`
- External links open in default browser.

## Branding Assets
- Installer and app branding icons are loaded from `build/`:
  - `build/icon.ico` (Windows installer/executable icon)
  - `build/icon.png` (BrowserWindow/mac/linux icon config)
- BrowserWindow icon uses a safe fallback resolver and does not crash if icon files are missing.

## NSIS Installer UX
- Installer uses guided mode (`oneClick: false`).
- Install directory can be changed.
- Desktop and Start Menu shortcuts are created with name `SingBetter AI`.
- Uninstall display name is `SingBetter AI`.
- User data is retained on uninstall (`deleteAppDataOnUninstall: false`).

## Packaging Notes
- Keep version in `package.json` updated for each release.
- Run installer smoke test on a clean Windows profile/VM.
- If code signing is added later, configure `electron-builder` signing env vars.

## Auto Updates (Step 5)
- Auto-updates are powered by `electron-updater` with `electron-builder` publish provider set to GitHub Releases.
- Desktop app checks for updates only in packaged desktop runtime (`app.isPackaged` + `DESKTOP_APP=1`).
- Updates download in background and prompt user to restart now or later.
- If user chooses later, update is applied automatically on next app quit/restart.
- Every release must bump `version` in `package.json`.

### Release Commands
1. Build installer artifacts:
   - `npm run desktop:win`
2. Publish release artifacts to GitHub Releases:
   - `npm run publish`
   - requires `GH_TOKEN` or `GITHUB_TOKEN` in environment with repo release permissions

### Artifacts Required For Updates (GitHub provider)
- `SingBetter AI Setup X.Y.Z.exe`
- `latest.yml`
- `*.blockmap`
- any accompanying files generated by electron-builder in `release/`

### Hosting Structure
- Provider is GitHub Releases (`wdwd720/SingBetter-AI`), so update artifacts are attached to each tagged release.
- Windows x64 updater resolves metadata from GitHub release assets (no custom update server).

### Code Signing Note
- Windows code signing is recommended to reduce SmartScreen warnings and improve update trust.
- Current config does not force signing, so development and unsigned testing remain possible.

### Quick Verification
1. Install `v1.0.0`.
2. Publish `v1.0.1` with `npm run publish`.
3. Reopen app and check desktop logs for:
   - `Auto-update: checking for updates`
   - `Auto-update: update available`
   - `Auto-update: update downloaded`
4. Accept restart prompt.
5. Relaunch and confirm app version is `v1.0.1`.

## DB Location In Desktop Builds
- Desktop runtime always sets:
  - `DATABASE_URL=file:<userData>/singbetter.db`
- This override is applied before server startup, so Drizzle/SQLite initializes against userData, not project root.
- Startup logs include the active DB path and uploads path.

## Verification Checklist
1. Run `npm run desktop:dev`.
2. Confirm app opens and icon appears in window/taskbar.
3. In terminal output, confirm one startup line contains:
   - `userData=...`
   - `db=...\\singbetter.db`
   - `uploads=...\\uploads`
4. Run `npm run desktop:win`.
5. Confirm installer is generated in `release/`.
6. Run installer and verify:
   - wizard UI appears
   - install directory can be changed
   - desktop shortcut is created
   - start menu shortcut is created
7. Launch installed app and verify non-default app icon is shown.
8. Confirm DB and upload paths are under `%APPDATA%\\SingBetter AI\\`.
9. Create data in app, close app, relaunch, and confirm data persists.
10. Uninstall app and confirm `%APPDATA%\\SingBetter AI\\` data still exists.
